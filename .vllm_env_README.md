# vLLM Environment Configuration

This file (`.vllm_env`) contains essential environment variables for running vLLM with VERL.

## Purpose

The `.vllm_env` file solves the following issues:
1. **GCC compilation error**: vLLM needs to compile CUDA utilities during initialization in Ray worker processes, but fails to link against `libcuda.so`. This is solved by:
   - Setting `CC=/usr/local/bin/gcc-wrapper` to use a custom GCC wrapper that automatically adds `-L/usr/local/cuda/lib64/stubs` when compiling with `-lcuda`
   - Adding `/usr/local/cuda/lib64/stubs` to `LD_LIBRARY_PATH` as a backup
2. **Ray/Threading configuration**: Reduces resource usage and prevents pthread_create failures.
3. **Triton configuration**: Disables Triton flash attention and uses CUDA FlashAttention instead.

## Usage

Training scripts automatically source this file:

```bash
source "$PROJECT_ROOT/.vllm_env"
```

## When migrating to a new system

1. Copy the entire `verl_Uky` folder - the `.vllm_env` file will be included
2. **Important**: Also copy the GCC wrapper to the new system:
   ```bash
   sudo cp /usr/local/bin/gcc-wrapper /usr/local/bin/gcc-wrapper
   sudo chmod +x /usr/local/bin/gcc-wrapper
   ```
   Or run this on the new system to recreate it:
   ```bash
   sudo bash -c 'cat > /usr/local/bin/gcc-wrapper << '\''EOF'\''
   #!/bin/bash
   args=("$@")
   if [[ " ${args[@]} " =~ " -lcuda " ]]; then
       new_args=()
       for arg in "${args[@]}"; do
           if [[ "$arg" == "-lcuda" ]]; then
               new_args+=("-L/usr/local/cuda/lib64/stubs")
           fi
           new_args+=("$arg")
       done
       exec /usr/bin/gcc "${new_args[@]}"
   else
       exec /usr/bin/gcc "$@"
   fi
   EOF'
   sudo chmod +x /usr/local/bin/gcc-wrapper
   ```

## Environment Variables Set

- `RAY_num_prestart_python_workers=1`
- `RAY_worker_register_timeout_seconds=600`
- `OMP_NUM_THREADS=1`
- `OPENBLAS_NUM_THREADS=1`
- `MKL_NUM_THREADS=1`
- `TRITON_CACHE_DIR=/tmp/triton_cache`
- `VLLM_USE_TRITON_FLASH_ATTN=0`
- `VLLM_ATTENTION_BACKEND=FLASH_ATTN`
- `VLLM_WORKER_USE_RAY=1`
- `LD_LIBRARY_PATH` (with CUDA stubs prepended)
- `CC=/usr/local/bin/gcc-wrapper` (use custom GCC wrapper for CUDA linking)
